<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">src/render.js | API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/render.js~Render.html">Render</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/status.js~Status.html">Status</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/sublevel.js~Sublevel.html">Sublevel</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/unstick.js~Unstick.html">Unstick</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/vector.js~Vector.html">Vector</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-animate">animate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-clearIntroScreen">clearIntroScreen</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-clearLoseScreen">clearLoseScreen</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-clearWinScreen">clearWinScreen</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-displayIntroScreen">displayIntroScreen</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-displayLoseScreen">displayLoseScreen</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-displayWinScreen">displayWinScreen</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-restartOnLose">restartOnLose</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-restartOnWin">restartOnWin</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-waitToStart">waitToStart</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-audio">audio</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-actorChars">actorChars</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-obstacleChars">obstacleChars</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-scale">scale</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-settings">settings</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">actors</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/actors/door.js~Door.html">Door</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/actors/flag.js~Flag.html">Flag</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/actors/ladder.js~Ladder.html">Ladder</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/actors/pizza.js~Pizza.html">Pizza</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/actors/player.js~Player.html">Player</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/actors/spider.js~Spider.html">Spider</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/actors/sword.js~Sword.html">Sword</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/actors/zombie.js~Zombie.html">Zombie</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">decorations</div><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-decorationsBackground01">decorationsBackground01</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-decorationsForeround01">decorationsForeround01</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-decorationsBackground02">decorationsBackground02</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-decorationsForeground02">decorationsForeground02</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">maps</div><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-map01">map01</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-map02">map02</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/render.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import helpers from &apos;./helpers&apos;;
import { scale } from &apos;./globals&apos;;
import maps from &apos;./maps&apos;;
import { decorationsBackground01, decorationsForeground01 } from &apos;./decorations/decorations01&apos;;
import { decorationsBackground02, decorationsForeground02 } from &apos;./decorations/decorations02&apos;;

class Render {

  constructor(level, status) {
    const game = helpers.el(&apos;div&apos;, `game level${level.status.sublevelNumber}`);
    this.wrap = document.body.appendChild(game);
    this.level = level;
    this.status = status;
    this.actorLayer = null;
    this.swordLayer = null;
    this.statusLayer = null;
    this.drawPosteriorStaticLayers();
    this.drawAnteriorStaticLayers();
    this.drawAnimatedLayers();
  }

  clearGame() {
    this.wrap.parentNode.removeChild(this.wrap);
  }

  clearAnimatedLayers() {
    const animatedLayers = [this.actorLayer, this.swordLayer, this.statusLayer];
    animatedLayers.forEach((animatedLayer) =&gt; {
      if (animatedLayer) { this.wrap.removeChild(animatedLayer); }
    });
  }

  drawPosteriorStaticLayers() {
    this.wrap.appendChild(this.drawBackground());
    this.wrap.appendChild(this.drawObstacle());
  }

  drawAnteriorStaticLayers() {
    this.wrap.appendChild(this.drawForeground());
  }

  drawAnimatedLayers() {
    this.clearAnimatedLayers();
    const foreground = document.getElementsByClassName(&apos;foreground&apos;)[0];
    this.swordLayer = this.wrap.insertBefore(this.drawSword(), foreground);
    this.actorLayer = this.wrap.insertBefore(this.drawActors(), foreground);
    this.statusLayer = this.wrap.appendChild(this.drawStatus());
    this.scrollPlayerIntoView();
  }

  reorderActors() {
    const playerIndex = this.level.actors.findIndex(actor =&gt; actor.type === &apos;player&apos;);
    helpers.move(this.level.actors, playerIndex, this.level.actors.length - 1);
  }

  drawActors() {
    const wrap = helpers.el(&apos;div&apos;, &apos;actors&apos;);
    this.reorderActors();
    this.level.actors.forEach((actor) =&gt; {
      const el = wrap.appendChild(helpers.el(&apos;div&apos;, `actor ${actor.type}`));
      const style = el.style;
      let actions;
      let damageFilters;
      switch (actor.type) {
        case &apos;player&apos;:
          actions = [&apos;standing&apos;, &apos;running&apos;, &apos;squatting&apos;, &apos;crawling&apos;, &apos;climbing&apos;];
          damageFilters = [&apos;invert(100%)&apos;, &apos;saturate(100)&apos;];
          break;
        case &apos;zombie&apos;:
          actions = [&apos;walking&apos;];
          break;
        case &apos;skeleton&apos;:
          actions = [&apos;walking&apos;];
          break;
        case &apos;ghost&apos;:
          actions = [&apos;gliding&apos;];
          style.opacity = actor.opacity;
          damageFilters = [&apos;invert(100%)&apos;, &apos;saturate(100)&apos;, &apos;hue(100)&apos;];
          break;
        default:
      }
      style.width = `${actor.size.x * scale}px`;
      style.height = `${actor.size.y * scale}px`;
      style.left = `${actor.pos.x * scale}px`;
      style.top = `${actor.pos.y * scale}px`;
      if (actor.direction === &apos;left&apos;) { el.className += &apos; x-flip&apos;; }
      if (actions) {
        actions.forEach((action) =&gt; {
          if (actor.action[action]) {
            if (actor.type === &apos;player&apos;) {
              style.backgroundPosition = `${actor.spritePos.y}px ${actor.spritePos.x}px`;
            } else if (actor.type === &apos;zombie&apos;) {
              style.backgroundPosition = `${actor.spritePos.y}px ${actor.spritePos.x}px`;
            } else {
              style.backgroundImage = `url(&apos;${actor.images[action]}&apos;)`;
            }
          }
        });
      }
      if (damageFilters &amp;&amp; actor.damaged) {
        damageFilters.forEach((damageFilter) =&gt; {
          style.WebkitFilter = damageFilter;
        });
      }
    });
    return wrap;
  }

  draw(layer, cb) {
    const wrap = helpers.el(&apos;div&apos;, layer);
    const arr = cb(this.level.width, this.level.height);
    arr.forEach((itemType) =&gt; {
      const name = itemType.name;
      let size = itemType.size;
      itemType.status.forEach((status) =&gt; {
        if (status.customSize) { size = status.customSize; }
        const el = wrap.appendChild(helpers.el(&apos;div&apos;, name));
        const style = el.style;
        style.width = `${size.x * scale}px`;
        style.height = `${size.y * scale}px`;
        style.left = `${status.pos.x * scale}px`;
        style.top = `${status.pos.y * scale}px`;
        el.style.position = &apos;absolute&apos;;
      });
    });
    return wrap;
  }

  drawBackground() {
    let wrap;
    const layer = &apos;background&apos;;
    switch (this.level.sublevelNumber) {
      case 0:
        wrap = this.draw(layer, decorationsBackground01);
        break;
      case 1:
        wrap = this.draw(layer, decorationsBackground02);
        break;
      default:
    }
    return wrap;
  }

  drawForeground() {
    let wrap;
    const layer = &apos;foreground&apos;;
    switch (this.level.sublevelNumber) {
      case 0:
        wrap = this.draw(layer, decorationsForeground01);
        break;
      case 1:
        wrap = this.draw(layer, decorationsForeground02);
        break;
      default:
    }
    return wrap;
  }

  drawObstacle() {
    const table = helpers.el(&apos;table&apos;, &apos;non-actors&apos;);
    const style = table.style;
    style.width = `${this.level.width * scale}px`;
    style.backgroundRepeat = &apos;repeat&apos;;
    style.borderSpacing = &apos;0&apos;;
    style.borderCollapse = &apos;collapse&apos;;
    style.position = &apos;relative&apos;;
    this.level.typeMap.forEach((line) =&gt; {
      const row = table.appendChild(helpers.el(&apos;tr&apos;));
      row.style.height = `${scale}px`;
      line.forEach((type) =&gt; {
        row.appendChild(helpers.el(&apos;td&apos;, type));
      });
    });
    return table;
  }

  drawSword() {
    const self = this;
    const wrap = helpers.el(&apos;div&apos;, &apos;sword&apos;);
    this.level.player.swords.forEach((sword) =&gt; {
      const swordEl = wrap.appendChild(helpers.el(&apos;div&apos;, &apos;sword&apos;));
      const style = swordEl.style;
      if (sword.direction === &apos;right&apos;) { swordEl.className += &apos; right&apos;; }
      if (sword.direction === &apos;left&apos;) { swordEl.className += &apos; left&apos;; }
      style.width = `${sword.size.x * scale}px`;
      style.height = `${sword.size.y * scale}px`;
      style.left = `${sword.pos.x * scale}px`;
      style.top = `${sword.pos.y * scale}px`;
      style.position = &apos;absolute&apos;;
    });
    return wrap;
  }

  drawStatus() {
    const self = this;
    const wrap = helpers.el(&apos;div&apos;, &apos;status&apos;);
    const statusElem = wrap.appendChild(helpers.el(&apos;div&apos;, &apos;status-life-meter&apos;));
    for (let i = 0; i &lt; this.level.player.lifeMeter; i += 1) {
      statusElem.appendChild(helpers.el(&apos;div&apos;, &apos;status-life-meter-partition&apos;));
    }
    if (this.level.player.lifeMeter &lt; 10) {
      const emptyElem = 10 - this.level.player.lifeMeter;
      for (let i = 0; i &lt; emptyElem; i += 1) {
        statusElem.appendChild(helpers.el(&apos;div&apos;, &apos;status-life-meter-partition-empty&apos;));
      }
    }
    const scoreElem = wrap.appendChild(helpers.el(&apos;div&apos;, &apos;status-score&apos;));
    const scoreTitle = scoreElem.appendChild(helpers.el(&apos;div&apos;, &apos;status-score-title&apos;));
    const scoreScore = scoreElem.appendChild(helpers.el(&apos;div&apos;, &apos;status-score-score&apos;));
    scoreTitle.innerHTML = self.status.name;
    scoreScore.innerHTML = self.status.score;
    const levelElem = wrap.appendChild(helpers.el(&apos;div&apos;, &apos;status-level&apos;));
    const levelTitle = levelElem.appendChild(helpers.el(&apos;div&apos;, &apos;status-level-title&apos;));
    const levelLevel = levelElem.appendChild(helpers.el(&apos;div&apos;, &apos;status-level-level&apos;));
    levelTitle.innerHTML = &apos;Level&apos;.toUpperCase();
    levelLevel.innerHTML = `${self.level.status.levelNumber} - ${maps.length}`;
    const timerElem = wrap.appendChild(helpers.el(&apos;div&apos;, &apos;status-timer&apos;));
    const timerTitle = timerElem.appendChild(helpers.el(&apos;div&apos;, &apos;status-timer-title&apos;));
    const timerTimer = timerElem.appendChild(helpers.el(&apos;div&apos;, &apos;status-timer-timer&apos;));
    timerTitle.innerHTML = &apos;Time&apos;.toUpperCase();
    const time = self.status.time.toString();
    const shortTime = time.slice(0, time.length - 2);
    timerTimer.innerHTML = shortTime;
    return wrap;
  }

  scrollPlayerIntoView() {
    const width = this.wrap.clientWidth;
    const height = this.wrap.clientHeight;
    const xMargin = width / 3;
    const yMargin = height / 3;
    const left = this.wrap.scrollLeft;
    const top = this.wrap.scrollTop;
    const right = left + width;
    const bottom = top + height;
    const player = this.level.player;
    const center = player.pos.plus(player.size.times(0.5)).times(scale);
    if (center.x &lt; left + xMargin) {
      this.wrap.scrollLeft = center.x - xMargin;
    } else if (center.x &gt; right - xMargin) {
      this.wrap.scrollLeft = center.x + (xMargin - width);
    }
    if (center.y &lt; top + yMargin) {
      this.wrap.scrollTop = center.y - yMargin;
    } else if (center.y &gt; bottom - yMargin) {
      this.wrap.scrollTop = center.y + (yMargin - height);
    }
  }

}

export default Render;
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.5.2)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
